# 優化你的Go程式

這本書會告訴你如何去寫高效能的Go程式碼。

雖然書中有部分章節，會討論如何優化分散式系統中個別的服務(像是cache等等)，但是如何去設計一個高效能的分散式系統超出了本書的範圍。網路上可以找到許多關於分散式系統的優質文章，優化分散式系統涵蓋了完全不同的領域、不同的研究與設計之間的取捨。

**所有的內容都受到CC-BY-SA license的保護**

本書分成幾個主要章節：
1. 不寫出慢（爛？）程式的基本觀念
    * CS-101 入門課程
2. 如何寫出快的軟體
    * 針對Go的部分，教你如何妥善利用Go來寫出好程式
3. 寫出*真正*快的程式
    * 當我們優化完後，還是覺得不夠快、不夠好時的進階觀念

以上三個章節，可以各自濃縮、提煉成以下要點：
1. "講道理"
2. "可交付"
3. "高風險"

## 該在何時、何處開始優化
因為這很重要，所以我要~~說三次~~開門見山的說清楚：我們真的需要做優化這件事嗎？

優化是需要成本的。一般來說，可以把程式的複雜度或是工程師在寫程式時的腦袋負荷（cognitive load）當作是優化的成本。優化後的程式碼，幾乎都比沒有優化之前還要難懂。

另一方面，我們也需要考慮優化的經濟效益（economics of optimization）。身為一個軟體工程師，我們的時間是寶貴的，我們也必須考慮做優化這件事的機會成本：像是修產品的bug，開發新的feature等等。優化故然有趣，但不見得是該做的事。產品的效率當然重要，但完成進度並交付、保持程式的正確性等，這些事情也是不容忽視的部分。

選擇最需要優化的部分來優化。有時候，不見得是要增加CPU的使用效率，反而是增進使用者體驗（UX），像是簡單地增加一個進度條，或是先把畫面畫出來（rendering），再把一些耗時的運算放在背景跑等等。

有時候會有很明顯需要優化的地方：一個只需要一小時的事情卻花了三小時。想當然爾這邊優化後絕對會比沒有來得好。

若是單純地因為好優化而優化，並不值得。比起投入的時間，不如忽略這些小地方會更好。把這當成是更加妥善利用*你的*時間。我們需要選擇何時、何處去優化，可以看成是在“高效的軟體”和“高效的開發”之間，去找一個平衡點。

“過早的優化是萬惡之源”，相信大家都聽過這句名言。但是，我們卻忽略了這句話所代表的真正意義

> "軟體工程師浪費許多時間在考慮、擔心程式中瑣碎、不重要的地方的效能。考慮到後續的維持、除錯，嘗試去改善這些地方反而會帶來負面的結果。我們應該忽略這些細小的改進，一言以敝之：有97％的情形是不需要去做無謂的優化的（過早的優化是萬惡之源）。當然，我們不能忽略真正需要改進，那剩下的3%"
>
> -- <cite>Knuth</cite>

補充: https://www.youtube.com/watch?time_continue=429&v=3WBaY61c9sE
    * 簡單的優化還是要做的，不要忽略
    * 對演算法、資料結構有更多的理解，會讓我們更容易發現這些簡單的優化

我們應該優化嗎？
> 是的，但只有當這個程式很重要卻很慢，而且我們是可以在維持程式的正確性、穩定性和簡潔易讀的前提之下，讓他更快的時候
>
> -- <cite>The Practice of Programming, Kernighan and Pike</cite>

過早的優化可能會讓我們陷於特定的設計架構之中。通常，優化過的程式，比較不容易隨著需求改變而改動，也很難放棄（沉沒成本，指已投入且不可回收的成本）。

[BitFunnel performance estimation](http://bitfunnel.org/strangeloop)